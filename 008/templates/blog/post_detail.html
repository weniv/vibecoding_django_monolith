{% extends 'main/base.html' %}
{% load markdown_extras %}
{% load static %}

{% block title %}{{ post.title }} - Django 블로그{% endblock %}

{% block header %}
<header class="masthead" style="background-image: url('{% if post.thumbnail %}{{ post.thumbnail.url }}{% else %}{% static 'assets/img/post-bg.jpg' %}{% endif %}')">
    <div class="container position-relative px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-md-10 col-lg-8 col-xl-7">
                <div class="post-heading">
                    <h1>{{ post.title }}</h1>
                    <span class="meta">
                        작성자:
                        <a href="#!">{{ post.author.get_display_name }}</a>
                        · {{ post.created_at|date:"Y년 m월 d일" }}
                        · 조회수: {{ post.view_count }}
                        · 좋아요: {{ post.total_likes }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>
{% endblock %}

{% block content %}
<!-- Post Content-->
<article class="mb-4">
    <!-- 태그 -->
    {% if post.tags.all %}
    <div class="mb-4">
        {% for tag in post.tags.all %}
        <a href="{% url 'blog:post_by_tag' tag.slug %}" class="badge bg-info text-dark text-decoration-none me-1">
            <i class="fas fa-tag"></i> {{ tag.name }}
        </a>
        {% endfor %}
    </div>
    {% endif %}

    <!-- 게시글 내용 -->
    <div class="post-content">
        {{ post.content|markdown|safe }}
    </div>

    <!-- 수정일 표시 -->
    {% if post.updated_at != post.created_at %}
    <p class="text-muted fst-italic mt-4">
        <small>마지막 수정: {{ post.updated_at|date:"Y년 m월 d일 H:i" }}</small>
    </p>
    {% endif %}
</article>

<!-- 액션 버튼 -->
<div class="d-flex gap-2 mb-5">
    <a href="{% url 'blog:post_list' %}" class="btn btn-secondary">
        <i class="fas fa-list"></i> 목록으로
    </a>
    {% if user == post.author %}
    <a href="{% url 'blog:post_update' post.pk %}" class="btn btn-primary">
        <i class="fas fa-edit"></i> 수정
    </a>
    <a href="{% url 'blog:post_delete' post.pk %}" class="btn btn-danger">
        <i class="fas fa-trash"></i> 삭제
    </a>
    {% endif %}
</div>

<hr class="my-5" />

<!-- 댓글 섹션 -->
<section class="mb-5">
    <h2 class="mb-4"><i class="fas fa-comments"></i> 댓글 ({{ post.comments.count }})</h2>

    <!-- 댓글 작성 폼 -->
    {% if user.is_authenticated %}
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">댓글 작성</h5>
            <form method="post" action="{% url 'blog:comment_create' post.pk %}">
                {% csrf_token %}
                <div class="mb-3">
                    <textarea name="content" class="form-control" rows="3" placeholder="댓글을 입력하세요" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> 댓글 작성
                </button>
            </form>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        <a href="{% url 'accounts:login' %}" class="alert-link">로그인</a>하시면 댓글을 작성할 수 있습니다.
    </div>
    {% endif %}

    <!-- 댓글 목록 -->
    <div class="mt-4">
        {% for comment in post.comments.all %}
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <strong>{{ comment.author.get_display_name }}</strong>
                        <small class="text-muted ms-2">{{ comment.created_at|date:"Y년 m월 d일 H:i" }}</small>
                    </div>
                    {% if user == comment.author %}
                    <div class="btn-group btn-group-sm">
                        <a href="{% url 'blog:comment_update' comment.pk %}" class="btn btn-outline-primary">수정</a>
                        <a href="{% url 'blog:comment_delete' comment.pk %}" class="btn btn-outline-danger">삭제</a>
                    </div>
                    {% endif %}
                </div>
                <p class="card-text">{{ comment.content|linebreaks }}</p>
            </div>
        </div>
        {% empty %}
        <div class="text-center text-muted py-5">
            <i class="fas fa-comment-slash fa-3x mb-3"></i>
            <p>첫 댓글을 작성해보세요!</p>
        </div>
        {% endfor %}
    </div>
</section>
{% endblock %}
